<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚è‹±èªå†’éšªå³¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'baby-blue': '#E0F2FE',
                        'baby-green': '#DCFCE7',
                        'baby-yellow': '#FEF3C7',
                        'baby-pink': '#FCE7F3',
                        'soft-text': '#4B5563',
                    },
                    fontFamily: {
                        'sans': ['"Microsoft JhengHei"', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #E0F2FE; /* baby-blue */
            font-family: "Microsoft JhengHei", sans-serif;
            overflow-x: hidden;
            touch-action: manipulation; /* Prevent double-tap zoom on mobile */
        }
        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-hover:active {
            transform: scale(0.95);
        }
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .hidden {
            display: none !important;
        }
        /* Custom Scrollbar for Collection */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        .animate-bounce-custom {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="text-soft-text select-none">

    <div id="app" class="game-container relative bg-yellow-50">
        <!-- Lobby View -->
        <div id="lobby-view" class="view flex flex-col w-full h-screen max-h-screen bg-gradient-to-b from-yellow-300 via-orange-300 to-yellow-200 relative overflow-hidden">
            
            <!-- Background Pattern (Polka dots) -->
            <div class="absolute inset-0 opacity-30 pointer-events-none" 
                 style="background-image: radial-gradient(#fff 20%, transparent 20%); background-size: 30px 30px;">
            </div>

            <!-- Floating Decorations -->
            <div class="absolute top-10 left-10 text-4xl animate-bounce delay-100 opacity-60">â­</div>
            <div class="absolute bottom-20 right-10 text-5xl animate-bounce delay-700 opacity-60">ğŸˆ</div>
            <div class="absolute top-1/3 right-5 text-3xl animate-bounce delay-300 opacity-60">ğŸµ</div>

            <!-- Header -->
            <header class="mt-12 text-center z-10 relative animate-bounce-custom">
                <div class="inline-block bg-white/90 rounded-full px-10 py-4 shadow-[0_8px_0_rgba(0,0,0,0.1)] border-4 border-blue-400 transform -rotate-2">
                    <h1 class="text-4xl font-black text-blue-500 tracking-widest drop-shadow-sm" style="-webkit-text-stroke: 1px #3b82f6;">
                        HAPPY ENGLISH
                    </h1>
                </div>
            </header>

            <!-- NPC Stage Area -->
            <div class="flex-1 flex flex-col items-center justify-center z-10 relative -mt-10">
                <div class="relative group cursor-pointer" onclick="app.audio.playSound('click')">
                    <!-- NPC Glow -->
                    <div class="absolute inset-0 bg-white/50 rounded-full filter blur-xl group-hover:bg-white/70 transition-all"></div>
                    <!-- NPC Body -->
                    <div class="w-40 h-40 bg-white rounded-full flex items-center justify-center shadow-[0_10px_0_rgba(0,0,0,0.1)] animate-bounce-custom relative z-10 border-4 border-white ring-4 ring-yellow-200 group-hover:scale-110 transition-transform duration-300">
                        <span class="text-8xl filter drop-shadow-lg">â˜ï¸</span>
                    </div>
                    <!-- Speech Bubble -->
                    <div class="absolute -top-10 -right-20 bg-white px-4 py-2 rounded-2xl rounded-bl-none shadow-lg text-sm font-bold text-gray-600 animate-pulse">
                        Let's Play!
                    </div>
                </div>
                
                <div class="bg-black/20 text-white px-6 py-2 rounded-full text-lg font-bold mb-8 backdrop-blur-sm mt-4 shadow-inner">
                    é›²æœµå¯¶å¯¶çš„éŠæˆ²å¤§å»³
                </div>

                <!-- Game Grid -->
                <div class="grid grid-cols-2 gap-5 w-full max-w-md px-8">
                    <!-- Listening -->
                    <button onclick="app.startGame('listening')" class="group relative h-36 bg-yellow-400 rounded-[2rem] shadow-[0_8px_0_#b45309] active:shadow-none active:translate-y-[8px] transition-all flex flex-col items-center justify-center border-4 border-yellow-300 hover:brightness-110 overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <span class="text-5xl mb-2 transform group-hover:scale-125 transition-transform duration-300 filter drop-shadow-md">ğŸ‘‚</span>
                        <span class="font-black text-white text-xl tracking-wider drop-shadow-md" style="-webkit-text-stroke: 1px #92400e;">è½éŸ³è¾¨è­˜</span>
                    </button>
                    
                    <!-- Spelling -->
                    <button onclick="app.startGame('spelling')" class="group relative h-36 bg-pink-400 rounded-[2rem] shadow-[0_8px_0_#be185d] active:shadow-none active:translate-y-[8px] transition-all flex flex-col items-center justify-center border-4 border-pink-300 hover:brightness-110 overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <span class="text-5xl mb-2 transform group-hover:scale-125 transition-transform duration-300 filter drop-shadow-md">ğŸ”¤</span>
                        <span class="font-black text-white text-xl tracking-wider drop-shadow-md" style="-webkit-text-stroke: 1px #9d174d;">æ‹¼å­—éŠæˆ²</span>
                    </button>

                    <!-- Matching -->
                    <button onclick="app.startGame('matching')" class="group relative h-36 bg-green-400 rounded-[2rem] shadow-[0_8px_0_#15803d] active:shadow-none active:translate-y-[8px] transition-all flex flex-col items-center justify-center border-4 border-green-300 hover:brightness-110 overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <span class="text-5xl mb-2 transform group-hover:scale-125 transition-transform duration-300 filter drop-shadow-md">ğŸ§©</span>
                        <span class="font-black text-white text-xl tracking-wider drop-shadow-md" style="-webkit-text-stroke: 1px #166534;">é€£é€£çœ‹</span>
                    </button>

                    <!-- Learning -->
                    <button onclick="app.startLearning()" class="group relative h-36 bg-blue-400 rounded-[2rem] shadow-[0_8px_0_#1d4ed8] active:shadow-none active:translate-y-[8px] transition-all flex flex-col items-center justify-center border-4 border-blue-300 hover:brightness-110 overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <span class="text-5xl mb-2 transform group-hover:scale-125 transition-transform duration-300 filter drop-shadow-md">ğŸ“–</span>
                        <span class="font-black text-white text-xl tracking-wider drop-shadow-md" style="-webkit-text-stroke: 1px #1e40af;">å–®å­—å°æ›¸</span>
                    </button>
                </div>
            </div>

            <!-- Footer Buttons -->
            <div class="pb-10 z-10 relative text-center mt-4">
                 <button onclick="app.showRewards()" class="bg-white text-yellow-500 font-black text-xl px-10 py-4 rounded-full shadow-[0_6px_0_#cbd5e1] active:shadow-none active:translate-y-[6px] transition-all border-4 border-yellow-100 hover:bg-yellow-50 flex items-center mx-auto hover:scale-105">
                     <span class="mr-2 text-2xl">ğŸ†</span> æˆ‘çš„è²¼ç´™ç°¿
                 </button>
            </div>
        </div>

        <!-- Game View -->
        <div id="game-view" class="view hidden flex-col w-full h-full">
            <div class="flex justify-between items-center mb-6 bg-white/60 p-3 rounded-full">
                <button onclick="app.showLobby()" class="bg-white p-2 rounded-full shadow text-xl hover:bg-gray-50">ğŸ </button>
                <div class="font-bold text-xl text-blue-600">åˆ†æ•¸: <span id="score-display">0</span></div>
                <div class="font-bold text-xl text-purple-600">é¡Œè™Ÿ: <span id="question-counter">1/5</span></div>
            </div>

            <div id="game-content" class="flex-1 flex flex-col items-center justify-center">
                <!-- Dynamic Game Content -->
            </div>
            
            <!-- Feedback Overlay -->
            <div id="feedback-overlay" class="hidden absolute inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50">
                <div id="feedback-card" class="bg-white p-8 rounded-3xl shadow-2xl text-center transform scale-0 transition-transform duration-300">
                    <div id="feedback-icon" class="text-8xl mb-4">ğŸŒŸ</div>
                    <h2 id="feedback-text" class="text-3xl font-bold mb-6 text-green-500">ç­”å°äº†ï¼</h2>
                    <button id="next-btn" class="bg-blue-500 text-white px-8 py-3 rounded-full font-bold text-xl hover:bg-blue-600 shadow-lg">ä¸‹ä¸€é¡Œ â¡ï¸</button>
                </div>
            </div>
        </div>

        <!-- Learning View -->
        <div id="learning-view" class="view hidden flex-col w-full h-full pt-4">
            <div class="flex justify-between items-center mb-4 px-4">
                <button onclick="app.showLobby()" class="bg-white p-2 rounded-full shadow text-xl hover:bg-gray-50">ğŸ </button>
                <h2 class="text-2xl font-bold text-blue-600">å–®å­—å°æ›¸</h2>
                <div class="w-10"></div> <!-- Spacer -->
            </div>

            <!-- Category Filter -->
            <div id="learning-categories" class="flex overflow-x-auto space-x-2 pb-4 px-4 mb-2 scrollbar-hide">
                <!-- Categories injected here -->
            </div>

            <!-- Word Grid -->
            <div id="learning-content" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 sm:grid-cols-3 gap-4 content-start">
                <!-- Words injected here -->
            </div>
        </div>

        <!-- Reward View -->
        <div id="reward-view" class="view hidden w-full pt-10">
            <div class="bg-white/90 rounded-3xl shadow-xl p-6 min-h-[80vh] border-4 border-white relative">
                <button onclick="app.showLobby()" class="absolute top-4 right-4 text-3xl hover:scale-110 transition-transform">âœ–ï¸</button>
                <h2 class="text-3xl font-bold text-center text-blue-500 mb-8">æˆ‘çš„è²¼ç´™ç°¿</h2>
                
                <div id="sticker-grid" class="grid grid-cols-3 gap-4">
                    <!-- Stickers injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data Section ---
        const WORDS_DB = [
            { category: "Animals", word: "bird", emoji: "ğŸ¦", meaning: "å°é³¥" },
            { category: "Animals", word: "dog", emoji: "ğŸ¶", meaning: "ç‹—ç‹—" },
            { category: "Animals", word: "rabbit", emoji: "ğŸ°", meaning: "å…”å­" },
            { category: "Animals", word: "cat", emoji: "ğŸ±", meaning: "è²“å’ª" },
            { category: "Animals", word: "fish", emoji: "ğŸŸ", meaning: "é­š" },
            { category: "Animals", word: "cow", emoji: "ğŸ®", meaning: "ä¹³ç‰›" },
            { category: "Animals", word: "duck", emoji: "ğŸ¦†", meaning: "é´¨å­" },
            { category: "Animals", word: "pig", emoji: "ğŸ·", meaning: "å°è±¬" },
            { category: "Animals", word: "horse", emoji: "ğŸ´", meaning: "é¦¬" },
            { category: "Animals", word: "chicken", emoji: "ğŸ”", meaning: "é›" },
            { category: "Animals", word: "lion", emoji: "ğŸ¦", meaning: "ç…å­" },
            { category: "Animals", word: "tiger", emoji: "ğŸ¯", meaning: "è€è™" },
            { category: "Animals", word: "elephant", emoji: "ğŸ˜", meaning: "å¤§è±¡" },
            { category: "Animals", word: "zebra", emoji: "ğŸ¦“", meaning: "æ–‘é¦¬" },
            { category: "Animals", word: "bear", emoji: "ğŸ»", meaning: "ç†Š" },
            { category: "Body Parts", word: "hair", emoji: "ğŸ’‡", meaning: "é ­é«®" },
            { category: "Body Parts", word: "nose", emoji: "ğŸ‘ƒ", meaning: "é¼»å­" },
            { category: "Body Parts", word: "ears", emoji: "ğŸ‘‚", meaning: "è€³æœµ" },
            { category: "Body Parts", word: "eyes", emoji: "ğŸ‘€", meaning: "çœ¼ç›" },
            { category: "Body Parts", word: "mouth", emoji: "ğŸ‘„", meaning: "å˜´å·´" },
            { category: "Body Parts", word: "eyebrows", emoji: "ğŸ¤¨", meaning: "çœ‰æ¯›" },
            { category: "Body Parts", word: "head", emoji: "ğŸ—£ï¸", meaning: "é ­" },
            { category: "Body Parts", word: "eye", emoji: "ğŸ‘ï¸", meaning: "çœ¼ç›" },
            { category: "Body Parts", word: "face", emoji: "ğŸŒ", meaning: "è‡‰" },
            { category: "Colors", word: "green", emoji: "ğŸŸ¢", meaning: "ç¶ è‰²" },
            { category: "Colors", word: "orange", emoji: "ğŸŸ ", meaning: "æ©˜è‰²" },
            { category: "Colors", word: "purple", emoji: "ğŸŸ£", meaning: "ç´«è‰²" },
            { category: "Colors", word: "pink", emoji: "ğŸŒ¸", meaning: "ç²‰ç´…è‰²" },
            { category: "Colors", word: "gray", emoji: "ğŸŒ«ï¸", meaning: "ç°è‰²" },
            { category: "Colors", word: "red", emoji: "ğŸ”´", meaning: "ç´…è‰²" },
            { category: "Colors", word: "blue", emoji: "ğŸ”µ", meaning: "è—è‰²" },
            { category: "Colors", word: "black", emoji: "âš«", meaning: "é»‘è‰²" },
            { category: "Colors", word: "yellow", emoji: "ğŸŸ¡", meaning: "é»ƒè‰²" },
            { category: "Colors", word: "white", emoji: "âšª", meaning: "ç™½è‰²" },
            { category: "Family", word: "father", emoji: "ğŸ‘¨", meaning: "çˆ¸çˆ¸" },
            { category: "Family", word: "mother", emoji: "ğŸ‘©", meaning: "åª½åª½" },
            { category: "Family", word: "grandpa", emoji: "ğŸ‘´", meaning: "çˆºçˆº" },
            { category: "Family", word: "grandma", emoji: "ğŸ‘µ", meaning: "å¥¶å¥¶" },
            { category: "Family", word: "sister", emoji: "ğŸ‘§", meaning: "å§å¦¹" },
            { category: "Family", word: "brother", emoji: "ğŸ‘¦", meaning: "å…„å¼Ÿ" },
            { category: "Emotions and Feelings", word: "happy", emoji: "ğŸ˜„", meaning: "å¿«æ¨‚" },
            { category: "Emotions and Feelings", word: "sad", emoji: "ğŸ˜¢", meaning: "é›£é" },
            { category: "Emotions and Feelings", word: "sick", emoji: "ğŸ¤¢", meaning: "ç”Ÿç—…" },
            { category: "Emotions and Feelings", word: "angry", emoji: "ğŸ˜ ", meaning: "ç”Ÿæ°£" },
            { category: "Emotions and Feelings", word: "tired", emoji: "ğŸ˜´", meaning: "ç´¯" },
            { category: "Emotions and Feelings", word: "hungry", emoji: "ğŸ¤¤", meaning: "é¤“" },
            { category: "Numbers", word: "one", emoji: "1ï¸âƒ£", meaning: "ä¸€" },
            { category: "Numbers", word: "two", emoji: "2ï¸âƒ£", meaning: "äºŒ" },
            { category: "Numbers", word: "three", emoji: "3ï¸âƒ£", meaning: "ä¸‰" },
            { category: "Numbers", word: "four", emoji: "4ï¸âƒ£", meaning: "å››" },
            { category: "Numbers", word: "five", emoji: "5ï¸âƒ£", meaning: "äº”" },
            { category: "Numbers", word: "six", emoji: "6ï¸âƒ£", meaning: "å…­" },
            { category: "Numbers", word: "seven", emoji: "7ï¸âƒ£", meaning: "ä¸ƒ" },
            { category: "Numbers", word: "eight", emoji: "8ï¸âƒ£", meaning: "å…«" },
            { category: "Numbers", word: "nine", emoji: "9ï¸âƒ£", meaning: "ä¹" },
            { category: "Numbers", word: "ten", emoji: "ğŸ”Ÿ", meaning: "å" },
            { category: "Numbers", word: "eleven", emoji: "11", meaning: "åä¸€" },
            { category: "Numbers", word: "twelve", emoji: "12", meaning: "åäºŒ" },
            { category: "Occupations", word: "doctor", emoji: "ğŸ‘¨â€âš•ï¸", meaning: "é†«ç”Ÿ" },
            { category: "Occupations", word: "nurse", emoji: "ğŸ‘©â€âš•ï¸", meaning: "è­·å£«" },
            { category: "Occupations", word: "cook", emoji: "ğŸ‘¨â€ğŸ³", meaning: "å»šå¸«" },
            { category: "Occupations", word: "teacher", emoji: "ğŸ‘©â€ğŸ«", meaning: "è€å¸«" },
            { category: "Occupations", word: "student", emoji: "ğŸ’", meaning: "å­¸ç”Ÿ" },
            { category: "Personal Characteristics", word: "heavy", emoji: "ğŸ‹ï¸", meaning: "é‡" },
            { category: "Personal Characteristics", word: "short", emoji: "ğŸ“", meaning: "çŸ®/çŸ­" },
            { category: "Personal Characteristics", word: "thin", emoji: "ğŸ§£", meaning: "ç˜¦" },
            { category: "Personal Characteristics", word: "tall", emoji: "ğŸ¦’", meaning: "é«˜" },
            { category: "Personal Characteristics", word: "strong", emoji: "ğŸ’ª", meaning: "å¼·å£¯" },
            { category: "Personal Characteristics", word: "fat", emoji: "ğŸ–", meaning: "èƒ–" },
            { category: "School Supplies", word: "pen", emoji: "ğŸ–Šï¸", meaning: "åŸå­ç­†" },
            { category: "School Supplies", word: "pencil", emoji: "âœï¸", meaning: "é‰›ç­†" },
            { category: "School Supplies", word: "eraser", emoji: "ğŸ§¼", meaning: "æ©¡çš®æ“¦" },
            { category: "School Supplies", word: "ruler", emoji: "ğŸ“", meaning: "å°º" },
            { category: "School Supplies", word: "marker", emoji: "ğŸ–ï¸", meaning: "éº¥å…‹ç­†" },
            { category: "School Supplies", word: "pencil case", emoji: "ğŸ‘", meaning: "é‰›ç­†ç›’" },
            { category: "School Supplies", word: "book", emoji: "ğŸ“–", meaning: "æ›¸" },
            { category: "Toys", word: "robot", emoji: "ğŸ¤–", meaning: "æ©Ÿå™¨äºº" },
            { category: "Toys", word: "doll", emoji: "ğŸ", meaning: "æ´‹å¨ƒå¨ƒ" },
            { category: "Toys", word: "yo-yo", emoji: "ğŸª€", meaning: "æºœæºœçƒ" },
            { category: "Toys", word: "ball", emoji: "âš½", meaning: "çƒ" },
            { category: "Toys", word: "top", emoji: "ğŸŒªï¸", meaning: "é™€èº" },
            { category: "Toys", word: "kite", emoji: "ğŸª", meaning: "é¢¨ç®" },
            { category: "Actions", word: "dance", emoji: "ğŸ’ƒ", meaning: "è·³èˆ" },
            { category: "Actions", word: "draw", emoji: "ğŸ¨", meaning: "ç•«ç•«" },
            { category: "Actions", word: "swim", emoji: "ğŸŠ", meaning: "æ¸¸æ³³" },
            { category: "Actions", word: "sing", emoji: "ğŸ¤", meaning: "å”±æ­Œ" },
            { category: "Actions", word: "ride a bike", emoji: "ğŸš´", meaning: "é¨è…³è¸è»Š" }
        ];

        // --- Logic Section ---

        class DataManager {
            constructor() {
                this.storageKey = 'english_app_progress_v1';
                this.progress = this.loadProgress();
            }

            loadProgress() {
                const stored = localStorage.getItem(this.storageKey);
                return stored ? JSON.parse(stored) : { stickers: [] };
            }

            saveProgress() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.progress));
            }

            unlockSticker(stickerId) {
                if (!this.progress.stickers.includes(stickerId)) {
                    this.progress.stickers.push(stickerId);
                    this.saveProgress();
                    return true; // New sticker!
                }
                return false; // Already had it
            }

            getRandomWords(count, category = null) {
                let pool = WORDS_DB;
                if (category) {
                    pool = pool.filter(w => w.category === category);
                }
                // Fisher-Yates shuffle copy
                const shuffled = [...pool];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled.slice(0, count);
            }
            
            getAllCategories() {
                return [...new Set(WORDS_DB.map(w => w.category))];
            }
        }

        class AudioManager {
            constructor() {
                this.synth = window.speechSynthesis;
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            speak(text) {
                if (this.synth.speaking) {
                    this.synth.cancel();
                }
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.lang = 'en-US';
                utterThis.rate = 0.8; // Slower for kids
                this.synth.speak(utterThis);
            }

            speakChinese(text) {
                if (this.synth.speaking) {
                    this.synth.cancel();
                }
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.lang = 'zh-TW';
                utterThis.rate = 1.0;
                this.synth.speak(utterThis);
            }

            playSound(type) {
                if (this.audioCtx.state === 'suspended') {
                    this.audioCtx.resume();
                }
                const osc = this.audioCtx.createOscillator();
                const gainNode = this.audioCtx.createGain();
                
                osc.connect(gainNode);
                gainNode.connect(this.audioCtx.destination);

                if (type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, this.audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(300, this.audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, this.audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioCtx.currentTime + 0.1);
                    osc.start();
                    osc.stop(this.audioCtx.currentTime + 0.1);
                } else if (type === 'success') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, this.audioCtx.currentTime);
                    osc.frequency.setValueAtTime(880, this.audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, this.audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.01, this.audioCtx.currentTime + 0.5);
                    osc.start();
                    osc.stop(this.audioCtx.currentTime + 0.5);
                } else if (type === 'error') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, this.audioCtx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, this.audioCtx.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.3, this.audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.01, this.audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(this.audioCtx.currentTime + 0.3);
                }
            }
        }

        class UIManager {
            constructor() {
                this.views = {
                    lobby: document.getElementById('lobby-view'),
                    game: document.getElementById('game-view'),
                    reward: document.getElementById('reward-view'),
                    learning: document.getElementById('learning-view')
                };
                this.gameContent = document.getElementById('game-content');
                this.scoreDisplay = document.getElementById('score-display');
                this.questionCounter = document.getElementById('question-counter');
                this.feedbackOverlay = document.getElementById('feedback-overlay');
                this.feedbackCard = document.getElementById('feedback-card');
                this.feedbackIcon = document.getElementById('feedback-icon');
                this.feedbackText = document.getElementById('feedback-text');
                this.nextBtn = document.getElementById('next-btn');
                this.stickerGrid = document.getElementById('sticker-grid');
                
                // Learning View Elements
                this.learningCategories = document.getElementById('learning-categories');
                this.learningContent = document.getElementById('learning-content');
            }

            switchView(viewName) {
                Object.values(this.views).forEach(el => el.classList.add('hidden'));
                this.views[viewName].classList.remove('hidden');
            }

            updateHeader(score, current, total) {
                this.scoreDisplay.innerText = score;
                this.questionCounter.innerText = `${current}/${total}`;
            }

            showFeedback(isCorrect, callback) {
                this.feedbackOverlay.classList.remove('hidden');
                // Trigger reflow for animation
                void this.feedbackCard.offsetWidth; 
                this.feedbackCard.classList.remove('scale-0');
                this.feedbackCard.classList.add('scale-100');

                if (isCorrect) {
                    this.feedbackIcon.innerText = "ğŸŒŸ";
                    this.feedbackText.innerText = "ç­”å°äº†ï¼";
                    this.feedbackText.className = "text-3xl font-bold mb-6 text-green-500";
                } else {
                    this.feedbackIcon.innerText = "ğŸ’ª";
                    this.feedbackText.innerText = "å†è©¦ä¸€æ¬¡ï¼";
                    this.feedbackText.className = "text-3xl font-bold mb-6 text-orange-500";
                }

                this.nextBtn.onclick = () => {
                    this.feedbackCard.classList.remove('scale-100');
                    this.feedbackCard.classList.add('scale-0');
                    setTimeout(() => {
                        this.feedbackOverlay.classList.add('hidden');
                        callback();
                    }, 300);
                };
            }

            renderStickers(ownedStickers) {
                this.stickerGrid.innerHTML = '';
                // Define some achievements/stickers
                const achievements = [
                    { id: 'listening_novice', icon: 'ğŸ‘‚', name: 'å°è€³æœµ' },
                    { id: 'spelling_novice', icon: 'ğŸ”¤', name: 'æ‹¼å­—ç‹' },
                    { id: 'matching_novice', icon: 'ğŸ§©', name: 'é…å°æ‰‹' },
                    { id: 'listening_master', icon: 'ğŸ§', name: 'é‡‘è€³æœµ' },
                    { id: 'spelling_master', icon: 'ğŸ“š', name: 'å–®å­—é€š' },
                    { id: 'matching_master', icon: 'âš¡', name: 'å¿«æ‰‹' },
                ];

                achievements.forEach(ach => {
                    const isOwned = ownedStickers.includes(ach.id);
                    const div = document.createElement('div');
                    div.className = `flex flex-col items-center p-4 rounded-2xl border-2 ${isOwned ? 'bg-white border-yellow-300 shadow-md' : 'bg-gray-100 border-gray-200 opacity-50'}`;
                    div.innerHTML = `
                        <div class="text-4xl mb-2 filter ${isOwned ? '' : 'grayscale'}">${ach.icon}</div>
                        <div class="text-sm font-bold ${isOwned ? 'text-gray-800' : 'text-gray-400'}">${ach.name}</div>
                    `;
                    this.stickerGrid.appendChild(div);
                });
            }
        }

        class App {
            constructor() {
                this.db = new DataManager();
                this.audio = new AudioManager();
                this.ui = new UIManager();
                
                this.currentGameState = {
                    type: null,
                    questions: [],
                    currentIndex: 0,
                    score: 0
                };
            }

            init() {
                this.showLobby();
            }

            showLobby() {
                this.ui.switchView('lobby');
                this.audio.playSound('click');
            }

            showRewards() {
                this.ui.renderStickers(this.db.progress.stickers);
                this.ui.switchView('reward');
                this.audio.playSound('click');
            }

            // --- Learning Mode ---
            startLearning() {
                this.ui.switchView('learning');
                this.audio.playSound('click');
                
                const categories = this.db.getAllCategories();
                this.renderLearningCategories(categories);
                // Default to first category
                if (categories.length > 0) {
                    this.renderLearningContent(categories[0]);
                }
            }

            renderLearningCategories(categories) {
                this.ui.learningCategories.innerHTML = '';
                categories.forEach((cat, index) => {
                    const btn = document.createElement('button');
                    btn.className = `whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold shadow transition-colors mr-2 mb-2 ${index === 0 ? 'bg-blue-500 text-white' : 'bg-white text-blue-500 hover:bg-blue-50'}`;
                    btn.innerText = cat;
                    btn.onclick = () => {
                        // Update active state
                        Array.from(this.ui.learningCategories.children).forEach(c => {
                            c.className = 'whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold shadow transition-colors mr-2 mb-2 bg-white text-blue-500 hover:bg-blue-50';
                        });
                        btn.className = 'whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold shadow transition-colors mr-2 mb-2 bg-blue-500 text-white';
                        
                        this.renderLearningContent(cat);
                        this.audio.playSound('click');
                    };
                    this.ui.learningCategories.appendChild(btn);
                });
            }

            renderLearningContent(category) {
                const words = WORDS_DB.filter(w => w.category === category);
                this.ui.learningContent.innerHTML = '';
                
                words.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-3xl shadow-md flex flex-col items-center justify-between border-2 border-gray-100 hover:border-blue-200 transition-all h-48';
                    card.innerHTML = `
                        <div class="text-5xl mb-2">${item.emoji}</div>
                        <div class="text-xl font-bold text-gray-700 mb-1">${item.word}</div>
                        <div class="flex space-x-2 w-full mt-auto">
                            <button class="flex-1 bg-blue-100 text-blue-600 rounded-xl py-2 hover:bg-blue-200 transition-colors" onclick="app.audio.speak('${item.word}')">
                                ğŸ”Š
                            </button>
                            <button class="flex-1 bg-yellow-100 text-yellow-600 rounded-xl py-2 hover:bg-yellow-200 transition-colors" onclick="app.audio.speakChinese('${item.meaning}')">
                                ğŸ“–
                            </button>
                        </div>
                    `;
                    this.ui.learningContent.appendChild(card);
                });
            }

            startGame(type) {
                this.currentGameState = {
                    type: type,
                    questions: this.db.getRandomWords(5), // 5 questions per round
                    currentIndex: 0,
                    score: 0
                };
                this.audio.playSound('click');
                this.ui.switchView('game');
                this.playRound();
            }

            playRound() {
                const state = this.currentGameState;
                if (state.currentIndex >= state.questions.length) {
                    this.endGame();
                    return;
                }

                const currentWord = state.questions[state.currentIndex];
                this.ui.updateHeader(state.score, state.currentIndex + 1, state.questions.length);

                // Clear previous game content
                this.ui.gameContent.innerHTML = '';

                // Route to specific game logic
                if (state.type === 'listening') {
                    this.renderListeningGame(currentWord);
                } else if (state.type === 'spelling') {
                    this.renderSpellingGame(currentWord);
                } else if (state.type === 'matching') {
                    this.renderMatchingGame(currentWord);
                }
            }

            // Game Logic: Listening
            renderListeningGame(targetWord) {
                // Create options (1 correct + 3 distractors)
                const distractors = this.db.getRandomWords(3).filter(w => w.word !== targetWord.word);
                // Ensure we have enough distractors (if DB is small, might duplicate)
                while(distractors.length < 3) {
                     distractors.push(this.db.getRandomWords(1)[0]);
                }
                
                const options = [targetWord, ...distractors].sort(() => Math.random() - 0.5);

                const container = document.createElement('div');
                container.className = 'w-full max-w-md text-center';
                
                const playBtn = document.createElement('button');
                playBtn.className = 'bg-blue-400 text-white w-24 h-24 rounded-full text-4xl shadow-lg mb-4 hover:bg-blue-500 animate-bounce-custom';
                playBtn.innerHTML = 'ğŸ”Š';
                playBtn.onclick = () => this.audio.speak(targetWord.word);
                container.appendChild(playBtn);

                // Hint Button (Chinese)
                const hintBtn = document.createElement('button');
                hintBtn.className = 'block mx-auto mb-8 bg-yellow-100 text-yellow-600 px-4 py-2 rounded-full text-sm font-bold shadow hover:bg-yellow-200';
                hintBtn.innerHTML = 'ğŸ’¡ ä¸­æ–‡æç¤º';
                hintBtn.onclick = () => this.audio.speakChinese(targetWord.meaning);
                container.appendChild(hintBtn);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-4';
                
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'bg-white p-6 rounded-2xl shadow-md text-2xl font-bold hover:bg-blue-50 border-2 border-transparent hover:border-blue-300 transition-all';
                    // Show Emoji + Word
                    btn.innerHTML = `<div>${opt.emoji}</div><div class="text-lg mt-2">${opt.word}</div>`;
                    btn.onclick = () => this.checkAnswer(opt.word === targetWord.word);
                    grid.appendChild(btn);
                });
                container.appendChild(grid);

                this.ui.gameContent.appendChild(container);
                
                // Auto speak once after a short delay
                setTimeout(() => this.audio.speak(targetWord.word), 500);
            }

            // Game Logic: Spelling
            renderSpellingGame(targetWord) {
                const container = document.createElement('div');
                container.className = 'w-full max-w-md text-center';

                // Target Image/Emoji
                const img = document.createElement('div');
                img.className = 'text-8xl mb-4 animate-pulse';
                img.innerText = targetWord.emoji;
                container.appendChild(img);

                // Play sound btn small
                const soundBtn = document.createElement('button');
                soundBtn.className = 'mb-2 text-blue-500 font-bold bg-white px-3 py-1 rounded-full shadow mr-2';
                soundBtn.innerText = 'ğŸ”Š è½ç™¼éŸ³';
                soundBtn.onclick = () => this.audio.speak(targetWord.word);
                
                const hintBtn = document.createElement('button');
                hintBtn.className = 'mb-8 text-yellow-600 font-bold bg-yellow-100 px-3 py-1 rounded-full shadow';
                hintBtn.innerText = 'ğŸ’¡ ä¸­æ–‡';
                hintBtn.onclick = () => this.audio.speakChinese(targetWord.meaning);
                
                const btnContainer = document.createElement('div');
                btnContainer.appendChild(soundBtn);
                btnContainer.appendChild(hintBtn);
                container.appendChild(btnContainer);

                // Slots
                const letters = targetWord.word.split('');
                const slotsDiv = document.createElement('div');
                slotsDiv.className = 'flex justify-center space-x-2 mb-8';
                let filledCount = 0;

                letters.forEach((_, idx) => {
                    const slot = document.createElement('div');
                    slot.className = 'w-10 h-12 border-b-4 border-gray-300 flex items-center justify-center text-2xl font-bold text-blue-600';
                    slot.dataset.index = idx;
                    slot.id = `slot-${idx}`;
                    slotsDiv.appendChild(slot);
                });
                container.appendChild(slotsDiv);

                // Shuffled Letters
                const shuffled = [...letters].sort(() => Math.random() - 0.5);
                const poolDiv = document.createElement('div');
                poolDiv.className = 'flex flex-wrap justify-center gap-3';

                shuffled.forEach((char, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'w-12 h-12 bg-white rounded-xl shadow-md text-xl font-bold hover:bg-yellow-100 transform hover:scale-110 transition-transform';
                    btn.innerText = char;
                    btn.onclick = (e) => {
                        // Find first empty slot
                        for(let k=0; k<letters.length; k++) {
                            const slot = document.getElementById(`slot-${k}`);
                            if (!slot.innerText) {
                                slot.innerText = char;
                                e.target.classList.add('opacity-0', 'pointer-events-none'); // Hide used letter
                                filledCount++;
                                
                                // Check if full
                                if (filledCount === letters.length) {
                                    // Validate
                                    let userWord = '';
                                    for(let j=0; j<letters.length; j++) {
                                        userWord += document.getElementById(`slot-${j}`).innerText;
                                    }
                                    setTimeout(() => this.checkAnswer(userWord === targetWord.word), 500);
                                }
                                return;
                            }
                        }
                    };
                    poolDiv.appendChild(btn);
                });
                container.appendChild(poolDiv);

                this.ui.gameContent.appendChild(container);
            }

            // Game Logic: Matching
            renderMatchingGame(targetWord) {
                 const container = document.createElement('div');
                 container.className = 'w-full max-w-md text-center';

                 const wordCard = document.createElement('div');
                 wordCard.className = 'bg-white p-8 rounded-3xl shadow-lg mb-4 inline-block border-4 border-green-200';
                 wordCard.innerHTML = `<div class="text-4xl font-bold text-gray-700">${targetWord.word}</div>`;
                 container.appendChild(wordCard);

                 // Hint Button
                 const hintBtn = document.createElement('button');
                 hintBtn.className = 'block mx-auto mb-8 bg-yellow-100 text-yellow-600 px-4 py-2 rounded-full text-sm font-bold shadow hover:bg-yellow-200';
                 hintBtn.innerHTML = 'ğŸ’¡ ä¸­æ–‡æç¤º';
                 hintBtn.onclick = () => this.audio.speakChinese(targetWord.meaning);
                 container.appendChild(hintBtn);

                 // Options
                 const distractors = this.db.getRandomWords(3).filter(w => w.word !== targetWord.word);
                 while(distractors.length < 3) {
                     distractors.push(this.db.getRandomWords(1)[0]);
                 }
                 const options = [targetWord, ...distractors].sort(() => Math.random() - 0.5);

                 const grid = document.createElement('div');
                 grid.className = 'grid grid-cols-2 gap-4';
                 
                 options.forEach(opt => {
                     const btn = document.createElement('button');
                     btn.className = 'bg-white p-6 rounded-2xl shadow-md text-5xl hover:bg-green-50 border-2 border-transparent hover:border-green-300 transition-all';
                     btn.innerHTML = opt.emoji;
                     btn.onclick = () => {
                         this.audio.speak(opt.word);
                         this.checkAnswer(opt.word === targetWord.word);
                     };
                     grid.appendChild(btn);
                 });
                 container.appendChild(grid);

                 this.ui.gameContent.appendChild(container);
            }

            checkAnswer(isCorrect) {
                if (isCorrect) {
                    this.currentGameState.score += 20; // 100 pts total
                    this.audio.playSound('success');
                } else {
                    this.audio.playSound('error');
                }
                
                this.ui.showFeedback(isCorrect, () => {
                    this.currentGameState.currentIndex++;
                    this.playRound();
                });
            }

            endGame() {
                // Unlock stickers based on score
                const perfect = this.currentGameState.score === 100;
                let earned = false;
                
                if (perfect) {
                    if (this.currentGameState.type === 'listening') earned = this.db.unlockSticker('listening_master');
                    if (this.currentGameState.type === 'spelling') earned = this.db.unlockSticker('spelling_master');
                    if (this.currentGameState.type === 'matching') earned = this.db.unlockSticker('matching_master');
                } else if (this.currentGameState.score >= 60) {
                    if (this.currentGameState.type === 'listening') earned = this.db.unlockSticker('listening_novice');
                    if (this.currentGameState.type === 'spelling') earned = this.db.unlockSticker('spelling_novice');
                    if (this.currentGameState.type === 'matching') earned = this.db.unlockSticker('matching_novice');
                }
                
                const msg = `éŠæˆ²çµæŸï¼\nå¾—åˆ†: ${this.currentGameState.score}\n${earned ? 'ğŸ‰ ç²å¾—æ–°è²¼ç´™ï¼' : ''}`;
                alert(msg);
                this.showLobby();
            }
        }

        // --- Bootstrap ---
        const app = new App();
        app.init();

        // --- Simple Unit Tests ---
        class TestSuite {
            constructor() {
                this.db = new DataManager();
                this.passed = 0;
                this.failed = 0;
            }

            assert(condition, message) {
                if (condition) {
                    console.log(`%c[PASS] ${message}`, 'color: green');
                    this.passed++;
                } else {
                    console.error(`[FAIL] ${message}`);
                    this.failed++;
                }
            }

            async run() {
                console.log('--- Starting Unit Tests ---');
                
                // Test 1: Data Loading
                this.assert(WORDS_DB.length > 0, 'Words DB should not be empty');
                this.assert(this.db.getAllCategories().length > 0, 'Categories should exist');

                // Test 2: Random Words
                const randoms = this.db.getRandomWords(5);
                this.assert(randoms.length === 5, 'Should return 5 random words');
                this.assert(randoms[0] !== undefined, 'Random word should be defined');

                // Test 3: Progress
                const initialStickers = this.db.progress.stickers.length;
                this.db.unlockSticker('test_sticker');
                this.assert(this.db.progress.stickers.includes('test_sticker'), 'Sticker should be unlocked');
                
                // Cleanup test sticker
                this.db.progress.stickers = this.db.progress.stickers.filter(s => s !== 'test_sticker');
                this.db.saveProgress();

                console.log(`--- Tests Completed. Pass: ${this.passed}, Fail: ${this.failed} ---`);
            }
        }

        if (new URLSearchParams(window.location.search).has('test')) {
            new TestSuite().run();
        }

    </script>
</body>
</html>
